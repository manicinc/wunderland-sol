name: Deploy to Linode

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  APP_DIR: "/opt/wunderland-sol"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --node-linker=hoisted

      - name: Build native modules
        run: |
          pnpm rebuild better-sqlite3
          echo "=== Locating better_sqlite3.node after rebuild ==="
          find . -name 'better_sqlite3.node' -type f 2>/dev/null || echo "NOT FOUND after pnpm rebuild"
          # Fallback: use npm rebuild if pnpm didn't compile it
          if ! find . -name 'better_sqlite3.node' -type f 2>/dev/null | grep -q .; then
            echo "Falling back to npm rebuild..."
            npm rebuild better-sqlite3
            find . -name 'better_sqlite3.node' -type f 2>/dev/null || echo "STILL NOT FOUND"
          fi

      - name: Build Next.js app
        working-directory: app
        run: npx next build

      - name: Prepare deployment tarball
        run: |
          mkdir -p deploy
          cp -r app/.next/standalone/* deploy/

          # Copy full .next build output over standalone's partial .next/
          rsync -a --ignore-existing app/.next/ deploy/app/.next/

          # Copy native module binary (find it wherever pnpm/npm put it)
          SQLITE_BIN=$(find . -name 'better_sqlite3.node' -type f | head -1)
          if [ -n "$SQLITE_BIN" ]; then
            # Copy to both root and app node_modules so Node.js resolution finds it
            mkdir -p deploy/node_modules/better-sqlite3/build/Release
            cp "$SQLITE_BIN" deploy/node_modules/better-sqlite3/build/Release/
            mkdir -p deploy/app/node_modules/better-sqlite3/build/Release
            cp "$SQLITE_BIN" deploy/app/node_modules/better-sqlite3/build/Release/
            echo "Copied better-sqlite3 native binary from: $SQLITE_BIN"
          else
            echo "ERROR: better_sqlite3.node not found anywhere!"
            find . -path '*/better-sqlite3*' -type f | head -20
            exit 1
          fi

          mkdir -p deploy/app/public
          cp -r app/public/* deploy/app/public/ 2>/dev/null || true

          # Verify
          ls deploy/app/server.js
          ls deploy/app/.next/BUILD_ID
          ls deploy/node_modules/better-sqlite3/build/Release/better_sqlite3.node
          ls deploy/app/node_modules/better-sqlite3/build/Release/better_sqlite3.node

          # Create tarball in workspace (scp-action can only see workspace)
          cd deploy && tar czf ../deploy.tar.gz . && cd ..
          ls -lh deploy.tar.gz

      - name: Deploy to Linode
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            set -euo pipefail
            echo "[deploy] Stopping existing service..."
            systemctl stop wunderland-sol 2>/dev/null || true
            rm -rf /opt/wunderland-sol
            mkdir -p /opt/wunderland-sol

      - name: Upload tarball
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: deploy.tar.gz
          target: /tmp/

      - name: Extract and start
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            set -euo pipefail

            # Stop any Docker compose stack that might be using port 80/443
            if command -v docker &> /dev/null; then
              echo "[deploy] Stopping Docker stacks..."
              docker compose -f /app/wunderland/deployment/wunderland-sol/docker-compose.yml down 2>/dev/null || true
              docker stop $(docker ps -q) 2>/dev/null || true
            fi

            # Extract
            cd /opt/wunderland-sol
            tar xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz

            # Verify
            echo "=== Verify structure ==="
            ls -la /opt/wunderland-sol/app/server.js
            ls -la /opt/wunderland-sol/app/.next/BUILD_ID
            ls /opt/wunderland-sol/node_modules/next/package.json

            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi

            # Create systemd service
            cat > /etc/systemd/system/wunderland-sol.service << 'UNIT'
            [Unit]
            Description=WUNDERLAND ON SOL - Next.js App
            After=network.target

            [Service]
            Type=simple
            User=root
            WorkingDirectory=/opt/wunderland-sol/app
            ExecStart=/usr/bin/node server.js
            Restart=on-failure
            RestartSec=5
            Environment=NODE_ENV=production
            Environment=PORT=3000
            Environment=HOSTNAME=0.0.0.0

            [Install]
            WantedBy=multi-user.target
            UNIT

            # Setup Nginx with SSL (self-signed cert for Cloudflare Full mode)
            apt-get install -y nginx 2>/dev/null || true

            # Generate self-signed cert if not present
            if [ ! -f /etc/ssl/certs/wunderland.crt ]; then
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout /etc/ssl/private/wunderland.key \
                -out /etc/ssl/certs/wunderland.crt \
                -subj "/CN=wunderland.sh/O=Wunderland/C=US"
            fi

            cat > /etc/nginx/sites-available/wunderland-sol << 'NGINX'
            server {
                listen 80;
                listen 443 ssl;
                server_name wunderland.sh www.wunderland.sh sol.wunderland.sh _;

                ssl_certificate /etc/ssl/certs/wunderland.crt;
                ssl_certificate_key /etc/ssl/private/wunderland.key;

                location / {
                    proxy_pass http://127.0.0.1:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }
            }
            NGINX
            ln -sf /etc/nginx/sites-available/wunderland-sol /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default

            systemctl daemon-reload
            systemctl enable wunderland-sol
            systemctl restart wunderland-sol
            systemctl restart nginx

            sleep 3
            systemctl is-active wunderland-sol && echo "App is running!" || (journalctl -u wunderland-sol --no-pager -n 20 && exit 1)
