name: Test Suite

on:
  push:
    branches: [main, master]
    paths:
      - 'scripts/**'
      - 'tests/**'
      - 'lib/**'
      - 'vocab/**'
      - 'package.json'
      - 'vitest.config.js'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      
      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      
      - name: Run unit tests
        run: pnpm test
      
      - name: Run tests with coverage
        id: coverage
        run: |
          pnpm run test:coverage
          # Extract coverage percentage
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -e "const c=require('./coverage/coverage-summary.json').total; console.log(Math.round((c.lines.pct+c.branches.pct+c.functions.pct+c.statements.pct)/4))")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "üìä Coverage: $COVERAGE%"
          fi
      
      - name: Generate badges
        run: pnpm run badges
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: codex
          name: codex-coverage
        continue-on-error: true
      
      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: Archive badges
        uses: actions/upload-artifact@v4
        with:
          name: badges
          path: docs/badges/
          retention-days: 90

  vocab-tests:
    name: Vocabulary & NLP Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      
      - name: Test vocabulary files exist
        run: |
          echo "üìö Checking vocabulary files..."
          for category in subjects topics difficulty skills; do
            if [ ! -d "vocab/$category" ]; then
              echo "‚ùå Missing vocab/$category directory"
              exit 1
            fi
            count=$(ls -1 vocab/$category/*.txt 2>/dev/null | wc -l)
            if [ "$count" -eq 0 ]; then
              echo "‚ùå No .txt files in vocab/$category"
              exit 1
            fi
            echo "‚úÖ vocab/$category: $count files"
          done
          
          if [ ! -f "vocab/stopwords.txt" ]; then
            echo "‚ùå Missing vocab/stopwords.txt"
            exit 1
          fi
          echo "‚úÖ vocab/stopwords.txt exists"
      
      - name: Test vocab-loader
        run: |
          node -e "
            const { getVocabularyLoader } = require('./scripts/vocab-loader');
            const loader = getVocabularyLoader();
            const stats = loader.getStats();
            
            console.log('üìä Vocabulary Statistics:');
            console.log('   Stop words:', stats.stopWords);
            console.log('   Subjects:', Object.keys(stats.subjects).length, 'categories');
            console.log('   Topics:', Object.keys(stats.topics).length, 'categories');
            console.log('   Skills:', Object.keys(stats.skills || {}).length, 'categories');
            console.log('   Total terms:', stats.totalTerms);
            
            if (stats.stopWords < 50) throw new Error('Too few stop words');
            if (Object.keys(stats.subjects).length < 3) throw new Error('Too few subject categories');
            console.log('‚úÖ Vocabulary loader working correctly');
          "
      
      - name: Test classification
        run: |
          node -e "
            const { getVocabularyLoader } = require('./scripts/vocab-loader');
            const loader = getVocabularyLoader();
            
            // Test technology detection
            const techResult = loader.classify('Programming APIs and software development with JavaScript and React');
            if (!techResult.subjects.includes('technology')) {
              throw new Error('Failed to detect technology subject');
            }
            console.log('‚úÖ Technology subject detection works');
            
            // Test difficulty detection
            const beginnerResult = loader.classify('A basic introduction for beginners, simple and easy');
            if (beginnerResult.difficulty !== 'beginner') {
              throw new Error('Failed to detect beginner difficulty');
            }
            console.log('‚úÖ Difficulty detection works');
            
            // Test skill detection
            const skillResult = loader.classify('Learn TypeScript and React hooks for modern frontend development');
            if (skillResult.skills.length === 0) {
              console.warn('‚ö†Ô∏è No skills detected (may need vocabulary expansion)');
            } else {
              console.log('‚úÖ Skill detection works:', skillResult.skills.slice(0, 5).join(', '));
            }
          "

  cache-tests:
    name: Cache Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      
      - name: Test SQL cache functionality
        run: |
          echo "üóÑÔ∏è Testing SQL cache..."
          
          # First run (full index)
          echo "üìù First run (cold cache):"
          time pnpm run index -- --validate 2>&1 | tail -20
          
          # Second run (should use cache)
          echo "üìù Second run (warm cache):"
          time pnpm run index -- --validate 2>&1 | tail -10
          
          # Verify cache was created (check for any .db file)
          if ls .cache/*.db 1>/dev/null 2>&1; then
            echo "‚úÖ SQL cache working correctly"
          else
            echo "‚ö†Ô∏è No cache file found (using in-memory adapter)"
          fi
      
      - name: Test cache clear
        run: |
          pnpm run index -- --clear-cache
          echo "‚úÖ Cache clear works"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, vocab-tests]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      
      - name: Test full workflow
        run: |
          echo "üîÑ Running full indexing workflow..."

          # Run validation (may have suggestions, don't fail)
          pnpm run validate || true

          # Run indexer
          pnpm run index -- --validate || true
          
          # Check outputs
          if [ ! -f codex-index.json ]; then
            echo "‚ùå Index not generated"
            exit 1
          fi
          
          if [ ! -f codex-report.json ]; then
            echo "‚ùå Report not generated"
            exit 1
          fi
          
          # Verify JSON is valid
          node -e "JSON.parse(require('fs').readFileSync('codex-index.json'))"
          node -e "JSON.parse(require('fs').readFileSync('codex-report.json'))"
          
          # Verify index has skills
          node -e "
            const index = JSON.parse(require('fs').readFileSync('codex-index.json'));
            const hasSkills = index.some(e => e.metadata?.autoGenerated?.skills?.length > 0);
            if (!hasSkills) {
              console.warn('‚ö†Ô∏è No auto-generated skills found in index');
            } else {
              console.log('‚úÖ Skills found in index');
            }
          "
          
          echo "‚úÖ Full workflow passed"
      
      - name: Verify index structure
        run: |
          node -e "
            const index = JSON.parse(require('fs').readFileSync('codex-index.json'));
            
            console.log('üìä Index Statistics:');
            console.log('   Total entries:', index.length);
            
            let withSummary = 0, withKeywords = 0, withSkills = 0, withTaxonomy = 0;
            
            for (const entry of index) {
              if (entry.metadata?.summary) withSummary++;
              if (entry.metadata?.autoGenerated?.keywords?.length) withKeywords++;
              if (entry.metadata?.autoGenerated?.skills?.length) withSkills++;
              if (entry.metadata?.taxonomy?.subjects?.length || entry.metadata?.taxonomy?.topics?.length) withTaxonomy++;
            }
            
            console.log('   With summary:', withSummary);
            console.log('   With keywords:', withKeywords);
            console.log('   With skills:', withSkills);
            console.log('   With taxonomy:', withTaxonomy);
            
            if (index.length < 3) throw new Error('Index too small');
            console.log('‚úÖ Index structure valid');
          "
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-outputs
          path: |
            codex-index.json
            codex-report.json
            .cache/codex.db
          retention-days: 7

  # Commit badges to repo (main branch only)
  update-badges:
    name: Update Badges
    runs-on: ubuntu-latest
    needs: [unit-tests, integration]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Download badges artifact
        uses: actions/download-artifact@v4
        with:
          name: badges
          path: docs/badges/
      
      - name: Commit badges
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          if git diff --quiet docs/badges/; then
            echo "üìä No badge changes to commit"
          else
            git add docs/badges/
            git commit -m "chore: update coverage badges [skip ci]"
            git push
            echo "‚úÖ Badges updated"
          fi

