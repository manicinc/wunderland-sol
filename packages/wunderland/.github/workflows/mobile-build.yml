name: Mobile Build

on:
  push:
    tags:
      - 'v*.*.*'
      - 'mobile-*'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Build platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - ios

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  JAVA_VERSION: '17'

jobs:
  # Build Android
  build-android:
    if: github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build mobile web app
        working-directory: apps/fabric-mobile
        run: pnpm run build

      - name: Initialize Capacitor Android
        working-directory: apps/fabric-mobile
        run: |
          npx cap add android || true
          npx cap sync android

      - name: Decode keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > apps/fabric-mobile/android/app/release.keystore

      - name: Build Android APK (Debug)
        if: github.event_name == 'workflow_dispatch'
        working-directory: apps/fabric-mobile/android
        run: ./gradlew assembleDebug

      - name: Build Android AAB (Release)
        if: github.event_name == 'push' && env.ANDROID_KEYSTORE_BASE64 != ''
        working-directory: apps/fabric-mobile/android
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
            -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$ANDROID_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$ANDROID_KEY_PASSWORD"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: fabric-android-apk
          path: apps/fabric-mobile/android/app/build/outputs/apk/**/*.apk
          if-no-files-found: warn

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: fabric-android-aab
          path: apps/fabric-mobile/android/app/build/outputs/bundle/**/*.aab
          if-no-files-found: warn

      - name: Upload to Play Store (Internal Testing)
        if: github.event_name == 'push' && env.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON != ''
        uses: r0adkll/upload-google-play@v1
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: dev.frame.fabric
          releaseFiles: apps/fabric-mobile/android/app/build/outputs/bundle/release/*.aab
          track: internal
          status: draft

  # Build iOS
  build-ios:
    if: github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build mobile web app
        working-directory: apps/fabric-mobile
        run: pnpm run build

      - name: Initialize Capacitor iOS
        working-directory: apps/fabric-mobile
        run: |
          npx cap add ios || true
          npx cap sync ios

      - name: Install CocoaPods dependencies
        working-directory: apps/fabric-mobile/ios/App
        run: pod install

      - name: Build iOS (Simulator - Debug)
        if: github.event_name == 'workflow_dispatch'
        working-directory: apps/fabric-mobile/ios/App
        run: |
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            build

      - name: Setup iOS signing
        if: github.event_name == 'push' && env.APPLE_CERTIFICATES_P12_BASE64 != ''
        env:
          APPLE_CERTIFICATES_P12_BASE64: ${{ secrets.APPLE_CERTIFICATES_P12_BASE64 }}
          APPLE_CERTIFICATES_P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATES_P12_PASSWORD }}
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create temp keychain
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain

          # Import certificate
          echo "$APPLE_CERTIFICATES_P12_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATES_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          rm certificate.p12

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/build.mobileprovision

      - name: Build iOS (Release IPA)
        if: github.event_name == 'push' && env.APPLE_CERTIFICATES_P12_BASE64 != ''
        working-directory: apps/fabric-mobile/ios/App
        env:
          APPLE_CERTIFICATES_P12_BASE64: ${{ secrets.APPLE_CERTIFICATES_P12_BASE64 }}
        run: |
          # Archive
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath build/App.xcarchive \
            archive

          # Export IPA
          xcodebuild \
            -exportArchive \
            -archivePath build/App.xcarchive \
            -exportOptionsPlist ../../ExportOptions.plist \
            -exportPath build/ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: fabric-ios-ipa
          path: apps/fabric-mobile/ios/App/build/ipa/*.ipa
          if-no-files-found: warn

      - name: Upload to TestFlight
        if: github.event_name == 'push' && env.APPLE_API_PRIVATE_KEY != ''
        env:
          APPLE_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        run: |
          # Create API key file
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APPLE_API_PRIVATE_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

          # Upload to TestFlight
          xcrun altool --upload-app \
            --type ios \
            --file apps/fabric-mobile/ios/App/build/ipa/*.ipa \
            --apiKey "$APPLE_API_KEY_ID" \
            --apiIssuer "$APPLE_ISSUER_ID"

  # Create GitHub Release (only on tag push)
  release:
    if: startsWith(github.ref, 'refs/tags/') && (startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/mobile-'))
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.apk
            artifacts/**/*.aab
            artifacts/**/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
