server {
    listen 80;
    listen 443 ssl;
    server_name rabbithole.inc www.rabbithole.inc _;

    ssl_certificate /etc/ssl/certs/rabbithole.crt;
    ssl_certificate_key /etc/ssl/private/rabbithole.key;

    # ── Auth routes → Next.js (port 3000) ──
    # Auth.js/NextAuth handles these server-side in the Next.js app.
    # DO NOT send these to the API bridge (port 3001).
    location /api/auth/ {
        proxy_pass http://127.0.0.1:3000/api/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # ── Stripe routes → Next.js (port 3000) ──
    location /api/stripe/ {
        proxy_pass http://127.0.0.1:3000/api/stripe/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # ── Contact form → Next.js (port 3000) ──
    location /api/contact {
        proxy_pass http://127.0.0.1:3000/api/contact;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # ── Channel OAuth callbacks → Next.js (port 3000) ──
    location /api/channels/ {
        proxy_pass http://127.0.0.1:3000/api/channels/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # ── All other API routes → Express bridge (port 3001) ──
    location /api/ {
        proxy_pass http://127.0.0.1:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # ── Next.js app → port 3000 ──
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_cache_bypass $http_upgrade;
    }
}

# Redirect app.rabbithole.inc → rabbithole.inc
server {
    listen 80;
    listen 443 ssl;
    server_name app.rabbithole.inc;
    ssl_certificate /etc/ssl/certs/rabbithole.crt;
    ssl_certificate_key /etc/ssl/private/rabbithole.key;
    return 301 https://rabbithole.inc$request_uri;
}
